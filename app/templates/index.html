<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Entfernung per Auto</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 50px auto; }
    label { display: block; margin-top: 10px; }
    input[type="text"],
    input[type="date"] { width: 100%; padding: 8px; margin-top: 5px; }
    input[type="submit"] { margin-top: 20px; padding: 10px 20px; }
    .result { margin-top: 20px; color: green; font-weight: bold; }
    .error { margin-top: 20px; color: red; }
    .suggestions { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; background: white; position: absolute; z-index: 999; width: 100%; }
    .suggestion-item { padding: 5px; cursor: pointer; }
    .suggestion-item:hover { background-color: #eee; }
    .autocomplete-container { position: relative; }
  </style>
</head>
<body>
  <h1>Entfernung per PKW berechnen</h1>
  <form method="post">
    <label>Kundenname:
      <input type="text" name="kunde" required>
    </label>
    <label>Datum:
      <input type="date" name="datum" required>
    </label>
    <div class="autocomplete-container">
      <label>Startort:
        <input type="text" name="start" id="start" autocomplete="off" required>
        <div id="start-suggestions" class="suggestions"></div>
      </label>
    </div>
    <div class="autocomplete-container">
      <label>Zielort:
        <input type="text" name="ziel" id="ziel" autocomplete="off" required>
        <div id="ziel-suggestions" class="suggestions"></div>
      </label>
    </div>
    <input type="submit" value="Berechnen">
  </form>

  {% if error %}
    <div class="error">{{ error }}</div>
  {% endif %}

  {% if result %}
    <div class="result">
      <p><strong>Kunde:</strong> {{ result.kunde }}</p>
      <p><strong>Datum:</strong> {{ result.datum }}</p>
      <p><strong>Start:</strong> {{ result.start }}</p>
      <p><strong>Ziel:</strong> {{ result.ziel }}</p>
      <p><strong>Entfernung:</strong> {{ result.entfernung }} km</p>
      <p><strong>Fahrzeit:</strong> {{ result.fahrzeit }} Minuten</p>
      <form method="post" action="/save">
        <input type="submit" value="Speichern" style="background-color: #007bff; color: white;">
      </form>
    </div>
  {% endif %}

  <form action="/open_excel" method="get">
    <input type="submit" value="Excel-Datei Ã¶ffnen" style="margin-top:10px; background-color:#28a745; color:white;">
  </form>

  <script>
    async function autocomplete(inputId, suggestionsId, apiKey) {
      const input = document.getElementById(inputId);
      const suggestionsBox = document.getElementById(suggestionsId);

      input.addEventListener('input', async () => {
        const query = input.value;
        if (query.length < 3) {
          suggestionsBox.innerHTML = "";
          return;
        }

        const response = await fetch(`https://api.openrouteservice.org/geocode/autocomplete?api_key=${apiKey}&text=${encodeURIComponent(query)}&size=5`);
        const data = await response.json();

        suggestionsBox.innerHTML = "";

        if (data && data.features) {
          data.features.forEach(item => {
            const div = document.createElement("div");
            div.classList.add("suggestion-item");
            div.textContent = item.properties.label;
            div.addEventListener("click", () => {
              input.value = item.properties.label;
              suggestionsBox.innerHTML = "";
            });
            suggestionsBox.appendChild(div);
          });
        }
      });

      document.addEventListener("click", function(e) {
        if (!suggestionsBox.contains(e.target) && e.target !== input) {
          suggestionsBox.innerHTML = "";
        }
      });
    }

    const apiKey = "{{ api_key }}";
    autocomplete("start", "start-suggestions", apiKey);
    autocomplete("ziel", "ziel-suggestions", apiKey);
  </script>
</body>
</html>
