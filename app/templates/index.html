<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Fahrtenbuch-Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .suggestions-box {
            border: 1px solid #ccc;
            background-color: white;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            z-index: 999;
            width: 100%;
        }
        .suggestion {
            padding: 8px;
            cursor: pointer;
        }
        .suggestion:hover {
            background-color: #f0f0f0;
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            padding: 2rem;
            background-color: #f8f9fa;
        }

        h1 {
            color: #005AA7;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        h1 img {
            height: 40px;
        }

        form {
            margin-bottom: 2rem;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        input[type="text"], input[type="date"], input[type="number"], select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        input[readonly] {
            background-color: #e9ecef;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
            border-radius: 0 0 4px 4px;
        }

        .autocomplete-suggestions div {
            padding: 0.5rem;
            cursor: pointer;
        }

        .autocomplete-suggestions div:hover {
            background-color: #f1f1f1;
        }

        button {
            padding: 0.5rem 1rem;
            background-color: #005AA7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
        }

        th, td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }

        th {
            background-color: #f1f1f1;
        }

        .button-link {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }

        .error {
            color: red;
            font-weight: bold;
        }
    </style>
<script>
    function debounce(fn, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    function initAutocomplete(id) {
        const input = document.getElementById(id);
        const wrapper = input.parentElement;
        const box = document.createElement('div');
        box.className = 'autocomplete-suggestions';
        wrapper.appendChild(box);

        const fetchSuggestions = debounce(() => {
            const query = input.value;
            if (query.length < 3) return box.innerHTML = '';

            fetch(`/autocomplete?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    box.innerHTML = '';
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = item;
                        div.onclick = () => {
                            input.value = item;
                            box.innerHTML = '';
                        };
                        box.appendChild(div);
                    });
                });
        }, 300);

        input.addEventListener('input', fetchSuggestions);

        document.addEventListener('click', (e) => {
            if (!wrapper.contains(e.target)) box.innerHTML = '';
        });
    }

    window.onload = () => {
        document.getElementById('datum').value = new Date().toISOString().split('T')[0];
        initAutocomplete('start');
        initAutocomplete('ziel');
    }
</script>

</head>
<body>
    <div style="text-align: left; margin-bottom: 1rem;">
        <img src="{{ url_for('static', filename='logo.svg') }}" alt="Allianz Logo" style="height: 60px;">
    </div>
    <h1>Fahrtenbuch</h1>

    {% if error %}<p class="error">{{ error }}</p>{% endif %}

    <form method="POST">
        <label for="kunde">Kunde</label>
        <input type="text" name="kunde" id="kunde" required>

        <label for="datum">Datum</label>
        <input type="date" name="datum" id="datum" required>

        <label for="start">Startort</label>
        <div style="position: relative;">
        <input type="text" name="start" id="start" autocomplete="off" required>
        <div id="start-suggestions" class="suggestions-box"></div>
        </div>

        <label for="ziel">Zielort</label>
        <div style="position: relative;">
        <input type="text" name="ziel" id="ziel" autocomplete="off" required>
        <div id="ziel-suggestions" class="suggestions-box"></div>
        </div>

        <label for="entfernung">Entfernung (km)</label>
        <input type="text" name="entfernung" id="entfernung" readonly>

        <label for="fahrzeit">Fahrzeit (Minuten)</label>
        <input type="text" name="fahrzeit" id="fahrzeit" readonly>

        <label for="km_start">Kilometerstand Start</label>
        <input type="number" name="km_start" id="km_start" required>

        <label for="km_ende">Kilometerstand Ende</label>
        <input type="number" name="km_ende" id="km_ende" required>

        <label for="zweck">Zweck</label>
        <input type="text" name="zweck" id="zweck" required>

        <label for="kennzeichen">Kennzeichen</label>
        <input type="text" name="kennzeichen" id="kennzeichen" required value="geschÃ¤ftlich">

        <label for="fahrer">Fahrer</label>
        <select name="fahrer" id="fahrer" required>
            <option value="n.a.">n.a.</option>
            <option value="Regina">Regina</option>
            <option value="Christian">Christian</option>
        </select>

        <button type="submit">Berechnen</button>
    </form>

    {% if result %}
    <h2>Vorschau der Fahrt</h2>
    <table>
        <thead>
            <tr>
                <th>Kunde</th><th>Datum</th><th>Start</th><th>Ziel</th><th>Entfernung</th><th>Fahrzeit</th>
                <th>Km Start</th><th>Km Ende</th><th>Gefahrene Km</th><th>Zweck</th><th>Kennzeichen</th><th>Fahrer</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ result.kunde }}</td>
                <td>{{ result.datum }}</td>
                <td>{{ result.start }}</td>
                <td>{{ result.ziel }}</td>
                <td>{{ result.entfernung }}</td>
                <td>{{ result.fahrzeit }}</td>
                <td>{{ result.km_start }}</td>
                <td>{{ result.km_ende }}</td>
                <td>{{ result.gefahrene_km }}</td>
                <td>{{ result.zweck }}</td>
                <td>{{ result.kennzeichen }}</td>
                <td>{{ result.fahrer }}</td>
            </tr>
        </tbody>
    </table>

    <form method="POST" action="{{ url_for('save') }}">
        {% for key, value in result.items() %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endfor %}
        <button type="submitfunction debounce(fn, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    function initAutocomplete(id) {
        const input = document.getElementById(id);
        const wrapper = input.parentElement;
        const box = document.createElement('div');
        box.className = 'autocomplete-suggestions';
        wrapper.appendChild(box);

        const fetchSuggestions = debounce(() => {
            const query = input.value;
            if (query.length < 3) return box.innerHTML = '';

            fetch(`/autocomplete?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    box.innerHTML = '';
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = item;
                        div.onclick = () => {
                            input.value = item;
                            box.innerHTML = '';
                        };
                        box.appendChild(div);
                    });
                });
        }, 300);

        input.addEventListener('input', fetchSuggestions);

        document.addEventListener('click', (e) => {
            if (!wrapper.contains(e.target)) box.innerHTML = '';
        });
    }

    window.onload = () => {
        document.getElementById('datum').value = new Date().toISOString().split('T')[0];
        initAutocomplete('start');
        initAutocomplete('ziel');
    }">Speichern</button>
    </form>
    {% endif %}

    <a class="button-link" href="{{ url_for('alle') }}">ðŸ“„ Alle Fahrten anzeigen</a>
</body>
</html>
